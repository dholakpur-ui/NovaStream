<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NovaStream | Cinematic Video Vault</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --pink: #ff7eb9;
      --pink-glow: rgba(255, 126, 185, 0.3);
      --bg: #0f0f0f;
      --header-bg: #0f0f0f;
      --card-bg: #1e1e1e;
      --text: #ffffff;
      --text-muted: #aaaaaa;
      --border: #333333;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      padding-top: 70px;
      overflow-x: hidden;
    }

    /* --- NAVIGATION BAR --- */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 60px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
    }

    .logo { 
      font-size: 22px; 
      font-weight: 900; 
      cursor: pointer; 
      letter-spacing: -1px;
      user-select: none;
    }
    .logo span { 
      color: var(--pink); 
      text-shadow: 0 0 10px var(--pink); 
    }

    .search-area { 
      flex: 0 1 500px; 
      display: flex; 
    }
    .search-area input {
      width: 100%;
      background: #121212;
      border: 1px solid var(--border);
      color: white;
      padding: 10px 18px;
      border-radius: 40px 0 0 40px;
      outline: none;
      font-size: 15px;
      transition: border-color 0.3s;
    }
    .search-area input:focus { 
      border-color: var(--pink); 
    }
    .search-area button {
      background: #222;
      border: 1px solid var(--border);
      border-left: none;
      color: white;
      padding: 0 20px;
      border-radius: 0 40px 40px 0;
      cursor: pointer;
      transition: background 0.3s;
    }
    .search-area button:hover {
      background: #333;
    }

    .nav-actions { 
      display: flex; 
      align-items: center; 
      gap: 12px; 
    }

    .btn-create {
      background: var(--pink);
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.3s, box-shadow 0.3s;
    }
    .btn-create:hover { 
      transform: scale(1.05); 
      box-shadow: 0 0 15px var(--pink); 
    }

    .btn-logout {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: color 0.3s, border-color 0.3s;
    }
    .btn-logout:hover { 
      color: white; 
      border-color: #ff4d4d; 
    }

    /* --- HOME VIEW (GRID) --- */
    .container { 
      padding: 24px; 
      max-width: 1800px; 
      margin: 0 auto; 
    }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px 20px;
    }

    .video-card { 
      cursor: pointer; 
      border-radius: 12px; 
      transition: transform 0.3s; 
    }
    .video-card:hover {
      transform: translateY(-4px);
    }
    .thumbnail-box {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid transparent;
      transition: border-color 0.3s;
    }
    .video-card:hover .thumbnail-box { 
      border-color: var(--pink); 
    }
    .thumbnail-box video { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
    }
    
    .video-info { 
      display: flex; 
      margin-top: 12px; 
      gap: 12px; 
    }
    .v-details h3 { 
      margin: 0; 
      font-size: 16px; 
      line-height: 1.4;
      font-weight: 600;
    }
    .v-details p { 
      margin: 6px 0; 
      color: var(--text-muted); 
      font-size: 14px; 
    }
    .del-btn { 
      color: #ff4d4d; 
      background: none; 
      border: none; 
      font-size: 12px; 
      cursor: pointer; 
      padding: 0; 
      margin-top: 8px; 
      opacity: 0.6;
      transition: opacity 0.3s;
    }
    .del-btn:hover { 
      opacity: 1; 
      text-decoration: underline; 
    }

    /* --- THEATER MODE (PLAYER VIEW) --- */
    #playerView {
      display: none;
      padding: 24px 60px;
      max-width: 1600px;
      margin: 0 auto;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .main-video-col video {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
      background: #000;
    }

    .main-video-info h2 { 
      font-size: 24px; 
      margin: 20px 0 10px;
      font-weight: 600;
    }
    .desc-box {
      background: #272727;
      padding: 15px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-muted);
    }

    .sidebar-col { 
      display: flex; 
      flex-direction: column; 
      gap: 16px; 
    }
    .side-card { 
      display: flex; 
      gap: 12px; 
      cursor: pointer;
      transition: transform 0.2s;
    }
    .side-card:hover {
      transform: translateX(4px);
    }
    .side-thumb { 
      width: 160px; 
      height: 90px; 
      border-radius: 8px; 
      overflow: hidden; 
      background: #000; 
      flex-shrink: 0; 
    }
    .side-thumb video { 
      width: 100%; 
      height: 100%; 
      object-fit: cover; 
    }
    .side-info h4 { 
      margin: 0; 
      font-size: 14px; 
      line-height: 1.3; 
      color: #fff;
      font-weight: 500;
    }

    /* --- UPLOAD MODAL --- */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #1e1e1e;
      width: 95%;
      max-width: 500px;
      padding: 30px;
      border-radius: 20px;
      border: 1px solid var(--border);
      position: relative;
    }
    .modal-content h2 { 
      margin-top: 0; 
      color: var(--pink); 
    }
    .close-btn {
      position: absolute;
      top: 20px;
      right: 25px;
      font-size: 30px;
      cursor: pointer;
      color: var(--text-muted);
      transition: color 0.3s;
    }
    .close-btn:hover {
      color: white;
    }

    .modal-content input[type="text"],
    .modal-content textarea {
      width: 100%;
      background: #000;
      border: 1px solid #333;
      color: white;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: inherit;
      font-size: 14px;
    }
    .modal-content input[type="text"]:focus,
    .modal-content textarea:focus {
      outline: none;
      border-color: var(--pink);
    }

    /* --- PROGRESS BAR --- */
    .prog-wrap { 
      display: none; 
      margin-top: 20px; 
    }
    .prog-bg { 
      background: #333; 
      height: 8px; 
      border-radius: 10px; 
      overflow: hidden; 
    }
    .prog-fill { 
      height: 100%; 
      background: var(--pink); 
      width: 0%; 
      transition: width 0.3s; 
      box-shadow: 0 0 10px var(--pink); 
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state i {
      font-size: 64px;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    @media (max-width: 1000px) {
      #playerView { 
        grid-template-columns: 1fr; 
        padding: 15px; 
      }
      .navbar {
        padding: 0 15px;
      }
      .search-area {
        flex: 1;
        max-width: 300px;
      }
    }

    @media (max-width: 600px) {
      .logo {
        font-size: 18px;
      }
      .search-area {
        display: none;
      }
      .btn-create span {
        display: none;
      }
    }
    .main-footer {
    border-top: 1px solid var(--border);
    padding: 40px 20px;
    margin-top: 60px;
    text-align: center;
    background: #0a0a0a;
  }
  .footer-content h3 {
    color: var(--pink);
    margin-bottom: 15px;
  }
  .view-photos-btn {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: #1e1e1e;
    color: white;
    padding: 12px 25px;
    border-radius: 30px;
    text-decoration: none;
    border: 1px solid var(--pink);
    transition: 0.3s;
    font-weight: bold;
  }
  .view-photos-btn:hover {
    background: var(--pink);
    color: black;
    box-shadow: 0 0 20px var(--pink-glow);
  }
    .pin-card { position: relative; } /* Necessary for the badge positioning */
    
    .pin-card div { 
      opacity: 0; 
      transition: opacity 0.3s ease; 
    }
    
    .pin-card:hover div { 
      opacity: 1; 
    }
  </style>
</head>
<body>

  <header class="navbar">
    <div class="logo" onclick="goHome()">Nova<span>Stream</span></div>
    <div class="search-area">
      <input type="text" id="searchInput" placeholder="Search videos..." oninput="filterVideos()">
      <button><i class="fas fa-search"></i></button>
    </div>
    <div class="nav-actions">
      <button class="btn-create" onclick="toggleModal(true)">
        <i class="fas fa-plus"></i>
        <span>Create</span>
      </button>
      <button class="btn-logout" onclick="logout()">
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </header>

  <main class="container" id="homeView">
    <div class="video-grid" id="vGrid"></div>
  </main>

  <main id="playerView">
    <div class="main-video-col">
      <video id="mainPlayer" controls autoplay></video>
      <div class="main-video-info">
        <h2 id="viewTitle"></h2>
        <div class="desc-box" id="viewDesc"></div>
      </div>
    </div>
    <div class="sidebar-col" id="sidebarGrid"></div>
  </main>

  <div class="modal" id="upModal" onclick="closeModalOnOutsideClick(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
      <span class="close-btn" onclick="toggleModal(false)">&times;</span>
      <h2>Upload to Vault</h2>
      <input type="text" id="title" placeholder="Title" required>
      <textarea id="desc" placeholder="Description..." rows="4"></textarea>
      <input type="file" id="fIn" accept="video/*" style="margin: 10px 0;">
      <button class="btn-create" style="width:100%; justify-content:center;" onclick="handleUpload()">
        Publish
      </button>
      
      <div class="prog-wrap" id="prog">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px">
          <span id="pStat">Uploading...</span>
          <span id="pNum">0%</span>
        </div>
        <div class="prog-bg"><div class="prog-fill" id="pBar"></div></div>
      </div>
    </div>
  </div>

  <script>
    let allVideos = [];

    async function loadVideos() {
      try {
        const res = await fetch('/api/videos');
        if (res.status === 401) {
          return window.location.href = '/login.html';
        }
        allVideos = await res.json();
        renderGrid(allVideos);
      } catch (err) {
        console.error("Error loading videos:", err);
        showEmptyState("Unable to load videos");
      }
    }

    function renderGrid(list) {
      const grid = document.getElementById('vGrid');
      
      if (list.length === 0) {
        showEmptyState("No videos yet. Click Create to upload your first video!");
        return;
      }

      grid.innerHTML = list.map(v => `
        <div class="video-card" onclick="openTheaterMode('${v.id}')">
          <div class="thumbnail-box" onmouseenter="previewPlay(this)" onmouseleave="previewStop(this)">
            <video src="${v.url}#t=0.5" muted loop preload="metadata"></video>
          </div>
          <div class="video-info">
            <div class="v-details">
              <h3>${escapeHtml(v.title)}</h3>
              <p>${(v.size/1e6).toFixed(1)} MB</p>
              <button class="del-btn" onclick="event.stopPropagation(); deleteVid('${v.id}')">
                <i class="fas fa-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function showEmptyState(message) {
      document.getElementById('vGrid').innerHTML = `
        <div class="empty-state" style="grid-column: 1/-1;">
          <i class="fas fa-video"></i>
          <p>${message}</p>
        </div>
      `;
    }

    function openTheaterMode(id) {
      const vid = allVideos.find(v => v.id === id);
      if (!vid) return;

      document.getElementById('homeView').style.display = 'none';
      document.getElementById('playerView').style.display = 'grid';
      window.scrollTo(0, 0);

      const mainPlayer = document.getElementById('mainPlayer');
      mainPlayer.src = vid.url;
      document.getElementById('viewTitle').innerText = vid.title;
      document.getElementById('viewDesc').innerText = vid.description || "No description provided.";

      const others = allVideos.filter(v => v.id !== id);
      document.getElementById('sidebarGrid').innerHTML = others.map(v => `
        <div class="side-card" onclick="openTheaterMode('${v.id}')">
          <div class="side-thumb">
            <video src="${v.url}#t=0.5" muted preload="metadata"></video>
          </div>
          <div class="side-info">
            <h4>${escapeHtml(v.title)}</h4>
          </div>
        </div>
      `).join('');
    }

    async function handleUpload() {
      const file = document.getElementById('fIn').files[0];
      const title = document.getElementById('title').value.trim();

      if (!file) {
        alert("Please select a video file!");
        return;
      }

      if (!title) {
        alert("Please enter a title!");
        return;
      }

      const fd = new FormData();
      fd.append('video', file);
      fd.append('title', title);
      fd.append('description', document.getElementById('desc').value);

      document.getElementById('prog').style.display = 'block';
      
      const xhr = new XMLHttpRequest();
      
      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          document.getElementById('pBar').style.width = percent + '%';
          document.getElementById('pNum').innerText = percent + '%';
        }
      };

      xhr.onload = () => {
        if (xhr.status === 200) {
          document.getElementById('pStat').innerText = 'Upload complete!';
          setTimeout(() => location.reload(), 1000);
        } else {
          alert("Upload failed. Please try again.");
          document.getElementById('prog').style.display = 'none';
        }
      };

      xhr.onerror = () => {
        alert("Network error. Please check your connection.");
        document.getElementById('prog').style.display = 'none';
      };

      xhr.open('POST', '/api/upload');
      xhr.send(fd);
    }

    function previewPlay(el) {
      const video = el.querySelector('video');
      if (video) video.play().catch(() => {});
    }

    function previewStop(el) {
      const video = el.querySelector('video');
      if (video) {
        video.pause();
        video.currentTime = 0.5;
      }
    }

    function goHome() {
      const mainPlayer = document.getElementById('mainPlayer');
      mainPlayer.pause();
      mainPlayer.src = '';
      document.getElementById('playerView').style.display = 'none';
      document.getElementById('homeView').style.display = 'block';
    }

    function toggleModal(show) {
      document.getElementById('upModal').style.display = show ? 'flex' : 'none';
      if (!show) {
        // Reset form
        document.getElementById('title').value = '';
        document.getElementById('desc').value = '';
        document.getElementById('fIn').value = '';
        document.getElementById('prog').style.display = 'none';
        document.getElementById('pBar').style.width = '0%';
      }
    }

    function closeModalOnOutsideClick(event) {
      if (event.target === document.getElementById('upModal')) {
        toggleModal(false);
      }
    }

    function filterVideos() {
      const query = document.getElementById('searchInput').value.toLowerCase();
      const filtered = allVideos.filter(v => 
        v.title.toLowerCase().includes(query) ||
        (v.description && v.description.toLowerCase().includes(query))
      );
      renderGrid(filtered);
    }

    async function deleteVid(id) {
      if (!confirm("Are you sure you want to delete this video?")) return;

      try {
        const res = await fetch(`/api/videos/${encodeURIComponent(id)}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          await loadVideos();
        } else {
          alert("Failed to delete video.");
        }
      } catch (err) {
        console.error("Delete error:", err);
        alert("Error deleting video.");
      }
    }

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        window.location.href = '/api/logout';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initialize
    loadVideos();
  </script>
  <footer class="main-footer">
    <div class="footer-content">
      <h3>Discover More</h3>
      <p style="color: var(--text-muted); margin-bottom: 20px;">Explore our curated visual library and cinematic frames.</p>
      <a href="/photos.html" class="view-photos-btn">
        <i class="fas fa-camera-retro"></i> View Photos
      </a>
    </div>
  </footer>
</body>
</html>