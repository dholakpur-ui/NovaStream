<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NovaStream | Cinematic Video Vault</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --pink: #ff7eb9;
      --pink-glow: rgba(255, 126, 185, 0.3);
      --bg: #0f0f0f;
      --header-bg: #0f0f0f;
      --card-bg: #1e1e1e;
      --text: #ffffff;
      --text-muted: #aaaaaa;
      --border: #333333;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding-top: 70px;
      overflow-x: hidden;
    }

    /* --- NAVIGATION BAR --- */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 60px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      box-sizing: border-box;
    }

    .logo { 
      font-size: 22px; 
      font-weight: 900; 
      cursor: pointer; 
      letter-spacing: -1px;
    }
    .logo span { color: var(--pink); text-shadow: 0 0 10px var(--pink); }

    .search-area { flex: 0 1 500px; display: flex; }
    .search-area input {
      width: 100%;
      background: #121212;
      border: 1px solid var(--border);
      color: white;
      padding: 10px 18px;
      border-radius: 40px 0 0 40px;
      outline: none;
      font-size: 15px;
    }
    .search-area input:focus { border-color: var(--pink); }
    .search-area button {
      background: #222;
      border: 1px solid var(--border);
      border-left: none;
      color: white;
      padding: 0 20px;
      border-radius: 0 40px 40px 0;
      cursor: pointer;
    }

    .btn-create {
      background: var(--pink);
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
    }
    .btn-create:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--pink); }

    /* --- HOME VIEW (GRID) --- */
    .container { padding: 24px; max-width: 1800px; margin: 0 auto; }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px 20px;
    }

    .video-card { cursor: pointer; border-radius: 12px; transition: 0.3s; }
    .thumbnail-box {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid transparent;
    }
    .video-card:hover .thumbnail-box { border-color: var(--pink); }
    .thumbnail-box video { width: 100%; height: 100%; object-fit: cover; }
    
    .video-info { display: flex; margin-top: 12px; gap: 12px; }
    .v-details h3 { 
      margin: 0; 
      font-size: 16px; 
      line-height: 1.4; 
      display: -webkit-box; 
      -webkit-line-clamp: 2; 
      -webkit-box-orient: vertical; 
      overflow: hidden; 
    }
    .v-details p { margin: 6px 0; color: var(--text-muted); font-size: 14px; }
    .del-btn { color: #ff4d4d; background: none; border: none; font-size: 12px; cursor: pointer; padding: 0; margin-top: 8px; opacity: 0.6; }
    .del-btn:hover { opacity: 1; text-decoration: underline; }

    /* --- THEATER MODE (PLAYER VIEW) --- */
    #playerView {
      display: none;
      padding: 24px 60px;
      max-width: 1600px;
      margin: 0 auto;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .main-video-col video {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
      background: #000;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }

    .main-video-info h2 { font-size: 24px; margin: 20px 0 10px; }
    .desc-box {
      background: #272727;
      padding: 15px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .sidebar-col { display: flex; flex-direction: column; gap: 16px; }
    .side-card { display: flex; gap: 12px; cursor: pointer; }
    .side-thumb { width: 160px; height: 90px; border-radius: 8px; overflow: hidden; background: #000; flex-shrink: 0; }
    .side-thumb video { width: 100%; height: 100%; object-fit: cover; }
    .side-info h4 { margin: 0; font-size: 14px; line-height: 1.3; color: #fff; }
    .side-info p { margin: 4px 0; font-size: 12px; color: var(--text-muted); }

    /* --- UPLOAD MODAL --- */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #1e1e1e;
      width: 95%;
      max-width: 500px;
      padding: 30px;
      border-radius: 20px;
      position: relative;
      border: 1px solid var(--border);
    }
    .modal-content h2 { margin-top: 0; color: var(--pink); }
    .close-modal { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: var(--text-muted); }
    .modal input, .modal textarea {
      width: 100%; background: #000; border: 1px solid var(--border);
      color: white; padding: 12px; margin-bottom: 16px; border-radius: 8px; font-size: 14px;
    }
    .modal input:focus { border-color: var(--pink); outline: none; }

    /* --- PROGRESS BAR --- */
    .prog-wrap { display: none; margin-top: 20px; }
    .prog-bg { background: #333; height: 8px; border-radius: 10px; overflow: hidden; }
    .prog-fill { height: 100%; background: var(--pink); width: 0%; transition: 0.3s; box-shadow: 0 0 10px var(--pink); }

    @media (max-width: 1000px) {
      #playerView { grid-template-columns: 1fr; padding: 15px; }
      .sidebar-col { margin-top: 20px; }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <div class="logo" onclick="goHome()">Nova<span>Stream</span></div>
    <div class="search-area">
      <input type="text" id="searchInput" placeholder="Search videos..." oninput="filterVideos()">
      <button><i class="fas fa-search"></i></button>
    </div>
    <div class="nav-actions">
      <button class="btn-create" onclick="toggleModal(true)">
        <i class="fas fa-plus"></i> Create
      </button>
    </div>
  </header>

  <main class="container" id="homeView">
    <div class="video-grid" id="vGrid"></div>
  </main>

  <main id="playerView">
    <div class="main-video-col">
      <video id="mainPlayer" controls autoplay></video>
      <div class="main-video-info">
        <h2 id="viewTitle">Video Title</h2>
        <div class="desc-box" id="viewDesc">Description placeholder...</div>
      </div>
    </div>
    <div class="sidebar-col" id="sidebarGrid">
      </div>
  </main>

  <div class="modal" id="upModal">
    <div class="modal-content">
      <span class="close-modal" onclick="toggleModal(false)">&times;</span>
      <h2>Upload to Vault</h2>
      <input type="text" id="title" placeholder="What's the title?">
      <textarea id="desc" placeholder="Tell viewers about your video..." rows="4"></textarea>
      <p style="font-size: 12px; color: var(--text-muted);">Select video file:</p>
      <input type="file" id="fIn" accept="video/*">
      <button class="btn-create" style="width:100%; justify-content:center; margin-top:10px;" onclick="handleUpload()">Publish Video</button>
      
      <div class="prog-wrap" id="prog">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px">
          <span id="pStat">Sending to NovaStream...</span>
          <span id="pNum">0%</span>
        </div>
        <div class="prog-bg"><div class="prog-fill" id="pBar"></div></div>
      </div>
    </div>
  </div>

  <script>
    let allVideos = [];
    let xhr = null;

    // --- VIEW CONTROLS ---
    function goHome() {
      document.getElementById('mainPlayer').pause();
      document.getElementById('playerView').style.display = 'none';
      document.getElementById('homeView').style.display = 'block';
      loadVideos(); // Refresh list
    }

    function toggleModal(show) {
      document.getElementById('upModal').style.display = show ? 'flex' : 'none';
      if(!show) {
        document.getElementById('prog').style.display = 'none';
        document.getElementById('pBar').style.width = '0%';
      }
    }

    // --- UPLOAD LOGIC ---
    function handleUpload() {
      const file = document.getElementById('fIn').files[0];
      if (!file) return alert("Please select a video file.");

      const fd = new FormData();
      fd.append('video', file);
      fd.append('title', document.getElementById('title').value || "Untitled Video");
      fd.append('description', document.getElementById('desc').value || "");

      document.getElementById('prog').style.display = 'block';
      xhr = new XMLHttpRequest();

      xhr.upload.onprogress = (e) => {
        const p = Math.round((e.loaded / e.total) * 100);
        document.getElementById('pBar').style.width = p + '%';
        document.getElementById('pNum').innerText = p + '%';
        if(p >= 100) document.getElementById('pStat').innerText = "Processing (Cloud Sync)...";
      };

      xhr.onload = () => {
        if(xhr.status === 200) {
          toggleModal(false);
          alert("Video Published Successfully!");
          goHome();
        } else {
          alert("Upload failed. Try again.");
          document.getElementById('prog').style.display = 'none';
        }
      };

      xhr.open('POST', '/api/upload');
      xhr.send(fd);
    }

    // --- DATA LOADING & RENDERING ---
    async function loadVideos() {
      try {
        const res = await fetch('/api/videos');
        allVideos = await res.json();
        renderGrid(allVideos);
      } catch (err) { console.error("Error loading videos", err); }
    }

    function renderGrid(list) {
      const grid = document.getElementById('vGrid');
      grid.innerHTML = list.map(v => `
        <div class="video-card" onclick="openTheaterMode('${v.id}')">
          <div class="thumbnail-box" onmouseenter="previewPlay(this)" onmouseleave="previewStop(this)">
            <video src="${v.url}#t=0.5" muted loop preload="metadata"></video>
          </div>
          <div class="video-info">
            <div class="v-details">
              <h3>${v.title}</h3>
              <p>${(v.size/1e6).toFixed(1)} MB â€¢ Cloud Upload</p>
              <button class="del-btn" onclick="event.stopPropagation(); deleteVid('${v.id}')">Delete Forever</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    // --- THEATER MODE LOGIC ---
    function openTheaterMode(id) {
      const vid = allVideos.find(v => v.id === id);
      if (!vid) return;

      document.getElementById('homeView').style.display = 'none';
      document.getElementById('playerView').style.display = 'grid';
      window.scrollTo(0, 0);

      const player = document.getElementById('mainPlayer');
      player.src = vid.url;
      document.getElementById('viewTitle').innerText = vid.title;
      document.getElementById('viewDesc').innerText = vid.desc || "No description provided.";

      // Sidebar Recommendations
      const sidebar = document.getElementById('sidebarGrid');
      const others = allVideos.filter(v => v.id !== id);
      sidebar.innerHTML = others.map(v => `
        <div class="side-card" onclick="openTheaterMode('${v.id}')">
          <div class="side-thumb"><video src="${v.url}#t=0.5" muted></video></div>
          <div class="side-info">
            <h4>${v.title}</h4>
            <p>${(v.size/1e6).toFixed(1)} MB</p>
          </div>
        </div>
      `).join('');
    }

    // --- PREVIEW LOGIC ---
    function previewPlay(el) { el.querySelector('video').play(); }
    function previewStop(el) { 
      const v = el.querySelector('video');
      v.pause();
      v.currentTime = 0.5;
    }

    // --- UTILITIES ---
    function filterVideos() {
      const q = document.getElementById('searchInput').value.toLowerCase();
      renderGrid(allVideos.filter(v => v.title.toLowerCase().includes(q)));
    }

    async function deleteVid(id) {
      if(!confirm("This will remove the video from Cloudinary permanently. Continue?")) return;
      await fetch(`/api/videos/${encodeURIComponent(id)}`, { method: 'DELETE' });
      loadVideos();
    }

    // Start
    loadVideos();
  </script>
</body>
</html>