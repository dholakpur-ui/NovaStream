<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>NovaStream | Cinematic Video Vault</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --pink:#ff7eb9;
  --bg:#0f0f0f;
  --border:#333;
}
button:active { transform: scale(0.95); }
.video-card:active { transform: scale(0.98); }

body {
  margin:0;
  background:var(--bg);
  color:white;
  font-family:Roboto,sans-serif;
  padding-top:70px;
}

/* NAVBAR */
.navbar{
  position:fixed;top:0;width:100%;height:60px;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;background:#0f0f0f;border-bottom:1px solid var(--border);
  z-index:1000;
}
.logo{font-size:22px;font-weight:900;cursor:pointer}
.logo span{color:var(--pink);text-shadow:0 0 10px var(--pink)}

.search-area{display:flex;gap:10px;flex:0 1 420px}
.search-area input,select{
  background:#121212;color:white;border:1px solid var(--border);
  padding:8px 14px;border-radius:20px;outline:none;width:100%;
}

.btn-create{
  background:var(--pink);border:none;border-radius:25px;
  padding:10px 18px;font-weight:bold;cursor:pointer;
}
.btn-logout{
  background:none;border:1px solid var(--border);
  color:#aaa;padding:8px 15px;border-radius:20px;cursor:pointer;
}

/* GRID */
.container{max-width:1800px;margin:auto;padding:24px}
.video-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
  gap:25px;
}
.video-card{cursor:pointer}
.thumbnail-box{
  aspect-ratio:16/9;border-radius:12px;overflow:hidden;
  background:black;border:1px solid transparent;position:relative;
}
.thumbnail-box img{width:100%;height:100%;object-fit:cover}
.video-card:hover .thumbnail-box{border-color:var(--pink)}
.thumb-duration{
  position:absolute;bottom:8px;right:8px;
  background:rgba(0,0,0,.8);
  padding:3px 6px;border-radius:4px;font-size:11px;
}

/* PLAYER */
#playerView{
  display:none;max-width:1600px;margin:auto;
  padding:24px;gap:24px;grid-template-columns:1fr 380px;
}
.main-video-col video{width:100%;border-radius:12px;background:black}
.sidebar-col{display:flex;flex-direction:column;gap:14px}

/* MODAL */
.modal{
  position:fixed;inset:0;background:rgba(0,0,0,.9);
  display:none;align-items:center;justify-content:center;z-index:2000;
}
.modal-content{
  background:#1e1e1e;width:460px;padding:30px;
  border-radius:18px;border:1px solid var(--pink);
}
input,textarea{width:100%;background:black;color:white;border:1px solid #333;padding:10px;border-radius:8px}
#timeSlider{width:100%;accent-color:var(--pink)}
</style>
</head>

<body>

<header class="navbar">
  <div class="logo" onclick="goHome()">Nova<span>Stream</span></div>

  <div class="search-area">
    <select id="playlistFilter" onchange="applyFilters()">
      <option value="all">All Playlists</option>
    </select>
    <input id="searchInput" placeholder="Search..." oninput="applyFilters()">
  </div>

  <div>
    <button class="btn-create" onclick="toggleModal(true)">
      <i class="fas fa-plus"></i> Create
    </button>
    <button class="btn-logout" onclick="location.href='/api/logout'">
      <i class="fas fa-sign-out-alt"></i>
    </button>
  </div>
</header>

<main class="container" id="homeView">
  <div class="video-grid" id="vGrid"></div>
</main>

<main id="playerView">
  <div class="main-video-col">
    <video id="mainPlayer" controls autoplay></video>
    <h2 id="viewTitle"></h2>
    <div id="viewDesc" style="background:#222;padding:15px;border-radius:10px;color:#ccc"></div>
  </div>
  <div class="sidebar-col" id="sidebarGrid"></div>
</main>

<!-- UPLOAD MODAL -->
<div class="modal" id="upModal">
  <div class="modal-content">
    <h2 style="color:var(--pink)">Upload Video</h2>
    <input id="title" placeholder="Title">
    <textarea id="desc" placeholder="Description"></textarea>
    <input type="file" id="fIn" accept="video/*">
    <button class="btn-create" style="width:100%" onclick="handleUpload()">Publish</button>
    <button onclick="toggleModal(false)" style="background:none;border:none;color:#777;margin-top:10px">Cancel</button>
    <div id="prog" style="display:none;margin-top:15px">
      <div style="background:#333;height:8px;border-radius:5px">
        <div id="pBar" style="background:var(--pink);height:100%;width:0%"></div>
      </div>
    </div>
  </div>
</div>

<script>
let allVideos=[];

/* UTIL */
const formatDuration=s=>{
  if(!s)return"0:00";
  return Math.floor(s/60)+":"+String(Math.floor(s%60)).padStart(2,"0");
};

/* LOAD */
async function loadVideos(){
  const r=await fetch('/api/videos');
  if(r.status===401) return location.href='/login.html';
  allVideos=await r.json();
  updatePlaylistDropdown();
  renderGrid(allVideos);
}

/* GRID */
function renderGrid(list){
  vGrid.innerHTML=list.map(v=>{
    const thumb=v.url.replace('/upload/',`/upload/so_${v.thumbTime||0.5},w_500,c_fill,ar_16:9/`).replace('.mp4','.jpg');
    return`
    <div class="video-card">
      <div class="thumbnail-box" onclick="openTheaterMode('${v.id}')">
        <img src="${thumb}">
        <div class="thumb-duration">${formatDuration(v.duration)}</div>
      </div>
      <h3>${v.title}</h3>
      <p style="color:#aaa;font-size:13px">${v.playlist||'Uncategorized'} â€¢ ${(v.size/1e6).toFixed(1)} MB</p>
      <button onclick="openEditModal('${v.id}')">Edit</button>
      <button onclick="deleteVid('${v.id}')" style="color:#ff4d4d">Delete</button>
      <button onclick="navigator.clipboard.writeText('${v.url}'); alert('Link Copied!')" style="background:none; border:1px solid #444; color:#00d4ff; padding:5px 10px; border-radius:5px; cursor:pointer;">Share</button>
    </div>`;
  }).join('');
}

/* FILTER */
function applyFilters(){
  let q=searchInput.value.toLowerCase();
  let p=playlistFilter.value;
  let list=allVideos;
  if(p!=="all") list=list.filter(v=>v.playlist===p);
  if(q) list=list.filter(v=>v.title.toLowerCase().includes(q));
  renderGrid(list);
}

/* PLAYLIST */
function updatePlaylistDropdown(){
  const sets=[...new Set(allVideos.map(v=>v.playlist).filter(Boolean))];
  playlistFilter.innerHTML='<option value="all">All Playlists</option>'+
    sets.map(p=>`<option value="${p}">${p}</option>`).join('');
}

/* PLAYER */
function openTheaterMode(id){
  mainPlayer.onclick = () => mainPlayer.paused ? mainPlayer.play() : mainPlayer.pause();
  const v=allVideos.find(x=>x.id===id);
  homeView.style.display='none';
  playerView.style.display='grid';
  mainPlayer.src=v.url;
  viewTitle.innerText=v.title;
  viewDesc.innerText=v.description||'No description';
  sidebarGrid.innerHTML=allVideos.filter(x=>x.id!==id).map(s=>{
    const t=s.url.replace('/upload/',`/upload/so_${s.thumbTime||0.5},w_160,c_fill,ar_16:9/`).replace('.mp4','.jpg');
    return`
    <div style="display:flex;gap:10px;cursor:pointer" onclick="openTheaterMode('${s.id}')">
      <img src="${t}" style="width:120px;border-radius:8px">
      <div>${s.title}</div>
    </div>`;
  }).join('');
}

/* EDIT */
function openEditModal(id){
  document.querySelectorAll('.modal').forEach(m=>m.remove());
  const v=allVideos.find(x=>x.id===id);
  const m=document.createElement('div');
  m.className='modal';
  m.style.display='flex';
  m.innerHTML=`
  <div class="modal-content">
    <h2 style="color:var(--pink)">Settings</h2>
    <img id="thumbPreview" src="${v.url.replace('/upload/',`/upload/so_${v.thumbTime||0.5},w_500/`).replace('.mp4','.jpg')}" style="width:100%;border-radius:10px">
    <input type="range" id="timeSlider" min="0" max="${Math.floor(v.duration||60)}" step="0.5"
      value="${v.thumbTime||0.5}"
      oninput="thumbPreview.src='${v.url}'.replace('/upload/', '/upload/so_'+this.value+',w_500/').replace('.mp4','.jpg')">
    <input id="editPlaylist" value="${v.playlist||''}" placeholder="Playlist">
    <button class="btn-create" onclick="saveEdit('${v.id}')">Save</button>
    <button onclick="this.closest('.modal').remove()" style="background:none;border:none;color:#777">Cancel</button>
  </div>`;
  document.body.appendChild(m);
}

/* SAVE */
async function saveEdit(id){
  await fetch(`/api/videos/${encodeURIComponent(id)}/update`,{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      thumbTime:timeSlider.value,
      playlist:editPlaylist.value
    })
  });
  location.reload();
}

/* UPLOAD */
function handleUpload(){
  const f=fIn.files[0]; if(!f) return alert("Select file");
  const fd=new FormData();
  fd.append('video',f);
  fd.append('title',title.value);
  fd.append('description',desc.value);
  prog.style.display='block';
  const x=new XMLHttpRequest();
  x.upload.onprogress=e=>pBar.style.width=Math.round(e.loaded/e.total*100)+'%';
  x.onload=()=>location.reload();
  x.open('POST','/api/upload');
  x.send(fd);
}

/* DELETE */
async function deleteVid(id){
  if(confirm("Delete forever?")){
    await fetch(`/api/videos/${encodeURIComponent(id)}`,{method:'DELETE'});
    loadVideos();
  }
}

function toggleModal(s){upModal.style.display=s?'flex':'none'}
function goHome(){location.reload()}

loadVideos();
</script>
</body>
</html>


<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>NovaStream | Cinematic Video Vault</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --pink: #ff7eb9;
      --pink-glow: rgba(255, 126, 185, 0.3);
      --bg: #0f0f0f;
      --header-bg: #0f0f0f;
      --card-bg: #1e1e1e;
      --text: #ffffff;
      --text-muted: #aaaaaa;
      --border: #333333;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding-top: 70px;
      overflow-x: hidden;
    }

    /* --- NAVIGATION BAR --- */
    .navbar {
      position: fixed;
      top: 0;
      width: 100%;
      height: 60px;
      background: var(--header-bg);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 24px;
      border-bottom: 1px solid var(--border);
      z-index: 1000;
      box-sizing: border-box;
    }

    .logo { 
      font-size: 22px; 
      font-weight: 900; 
      cursor: pointer; 
      letter-spacing: -1px;
    }
    .logo span { color: var(--pink); text-shadow: 0 0 10px var(--pink); }

    .search-area { flex: 0 1 500px; display: flex; }
    .search-area input {
      width: 100%;
      background: #121212;
      border: 1px solid var(--border);
      color: white;
      padding: 10px 18px;
      border-radius: 40px 0 0 40px;
      outline: none;
      font-size: 15px;
    }
    .search-area input:focus { border-color: var(--pink); }
    .search-area button {
      background: #222;
      border: 1px solid var(--border);
      border-left: none;
      color: white;
      padding: 0 20px;
      border-radius: 0 40px 40px 0;
      cursor: pointer;
    }

    .nav-actions { display: flex; align-items: center; gap: 12px; }

    .btn-create {
      background: var(--pink);
      color: black;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: 0.3s;
    }
    .btn-create:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--pink); }

    .btn-logout {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
    }
    .btn-logout:hover { color: white; border-color: #ff4d4d; }

    /* --- HOME VIEW (GRID) --- */
    .container { padding: 24px; max-width: 1800px; margin: 0 auto; }
    .video-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 30px 20px;
    }

    .video-card { cursor: pointer; border-radius: 12px; transition: 0.3s; }
    .thumbnail-box {
      width: 100%;
      aspect-ratio: 16/9;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      border: 1px solid transparent;
    }
    .video-card:hover .thumbnail-box { border-color: var(--pink); }
    .thumbnail-box video { width: 100%; height: 100%; object-fit: cover; }
    
    .video-info { display: flex; margin-top: 12px; gap: 12px; }
    .v-details h3 { 
      margin: 0; 
      font-size: 16px; 
      line-height: 1.4; 
    }
    .v-details p { margin: 6px 0; color: var(--text-muted); font-size: 14px; }
    .del-btn { color: #ff4d4d; background: none; border: none; font-size: 12px; cursor: pointer; padding: 0; margin-top: 8px; opacity: 0.6; }
    .del-btn:hover { opacity: 1; text-decoration: underline; }

    /* --- THEATER MODE (PLAYER VIEW) --- */
    #playerView {
      display: none;
      padding: 24px 60px;
      max-width: 1600px;
      margin: 0 auto;
      grid-template-columns: 1fr 400px;
      gap: 24px;
    }

    .main-video-col video {
      width: 100%;
      aspect-ratio: 16/9;
      border-radius: 12px;
      background: #000;
    }

    .main-video-info h2 { font-size: 24px; margin: 20px 0 10px; }
    .desc-box {
      background: #272727;
      padding: 15px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
    }

    .sidebar-col { display: flex; flex-direction: column; gap: 16px; }
    .side-card { display: flex; gap: 12px; cursor: pointer; }
    .side-thumb { width: 160px; height: 90px; border-radius: 8px; overflow: hidden; background: #000; flex-shrink: 0; }
    .side-thumb video { width: 100%; height: 100%; object-fit: cover; }
    .side-info h4 { margin: 0; font-size: 14px; line-height: 1.3; color: #fff; }

    /* --- UPLOAD MODAL --- */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(5px);
    }
    .modal-content {
      background: #1e1e1e;
      width: 95%;
      max-width: 500px;
      padding: 30px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }
    .modal-content h2 { margin-top: 0; color: var(--pink); }

    /* --- PROGRESS BAR --- */
    .prog-wrap { display: none; margin-top: 20px; }
    .prog-bg { background: #333; height: 8px; border-radius: 10px; overflow: hidden; }
    .prog-fill { height: 100%; background: var(--pink); width: 0%; transition: 0.3s; box-shadow: 0 0 10px var(--pink); }

    @media (max-width: 1000px) {
      #playerView { grid-template-columns: 1fr; padding: 15px; }
    }
  </style>
</head>
<body>

  <header class="navbar">
    <div class="logo" onclick="goHome()">Nova<span>Stream</span></div>
    <div class="search-area">
      <input type="text" id="searchInput" placeholder="Search videos..." oninput="filterVideos()">
      <button><i class="fas fa-search"></i></button>
    </div>
    <div class="nav-actions">
      <button class="btn-create" onclick="toggleModal(true)"><i class="fas fa-plus"></i> Create</button>
      <button class="btn-logout" onclick="location.href='/api/logout'"><i class="fas fa-sign-out-alt"></i></button>
    </div>
  </header>

  <main class="container" id="homeView">
    <div class="video-grid" id="vGrid"></div>
  </main>

  <main id="playerView">
    <div class="main-video-col">
      <video id="mainPlayer" controls autoplay></video>
      <div class="main-video-info">
        <h2 id="viewTitle"></h2>
        <div class="desc-box" id="viewDesc"></div>
      </div>
    </div>
    <div class="sidebar-col" id="sidebarGrid"></div>
  </main>

  <div class="modal" id="upModal">
    <div class="modal-content">
      <h2 onclick="toggleModal(false)" style="float:right; cursor:pointer;">&times;</h2>
      <h2>Upload to Vault</h2>
      <input type="text" id="title" placeholder="Title">
      <textarea id="desc" placeholder="Description..." rows="4" style="width:100%; background:#000; color:white; border:1px solid #333; padding:10px; border-radius:8px;"></textarea>
      <input type="file" id="fIn" accept="video/*" style="margin: 10px 0;">
      <button class="btn-create" style="width:100%; justify-content:center;" onclick="handleUpload()">Publish</button>
      
      <div class="prog-wrap" id="prog">
        <div style="display:flex; justify-content:space-between; font-size:12px; margin-bottom:8px">
          <span id="pStat">Sending...</span>
          <span id="pNum">0%</span>
        </div>
        <div class="prog-bg"><div class="prog-fill" id="pBar"></div></div>
      </div>
    </div>
  </div>

  <script>
    let allVideos = [];

    async function loadVideos() {
      try {
        const res = await fetch('/api/videos');
        if (res.status === 401) return window.location.href = '/login.html';
        allVideos = await res.json();
        renderGrid(allVideos);
      } catch (err) { console.error("Error", err); }
    }

    function renderGrid(list) {
      document.getElementById('vGrid').innerHTML = list.map(v => `
        <div class="video-card" onclick="openTheaterMode('${v.id}')">
          <div class="thumbnail-box" onmouseenter="pP(this)" onmouseleave="pS(this)">
            <video src="${v.url}#t=0.5" muted loop></video>
          </div>
          <div class="video-info">
            <div class="v-details">
              <h3>${v.title}</h3>
              <p>${(v.size/1e6).toFixed(1)} MB</p>
              <button class="del-btn" onclick="event.stopPropagation(); deleteVid('${v.id}')">Delete</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    function openTheaterMode(id) {
      const vid = allVideos.find(v => v.id === id);
      document.getElementById('homeView').style.display = 'none';
      document.getElementById('playerView').style.display = 'grid';
      window.scrollTo(0, 0);

      document.getElementById('mainPlayer').src = vid.url;
      document.getElementById('viewTitle').innerText = vid.title;
      document.getElementById('viewDesc').innerText = vid.description || "No description.";

      const others = allVideos.filter(v => v.id !== id);
      document.getElementById('sidebarGrid').innerHTML = others.map(v => `
        <div class="side-card" onclick="openTheaterMode('${v.id}')">
          <div class="side-thumb"><video src="${v.url}#t=0.5" muted></video></div>
          <div class="side-info"><h4>${v.title}</h4></div>
        </div>
      `).join('');
    }

    function handleUpload() {
      const file = document.getElementById('fIn').files[0];
      if (!file) return alert("Select file!");
      const fd = new FormData();
      fd.append('video', file);
      fd.append('title', document.getElementById('title').value);
      fd.append('description', document.getElementById('desc').value);

      document.getElementById('prog').style.display = 'block';
      const xhr = new XMLHttpRequest();
      xhr.upload.onprogress = (e) => {
        const p = Math.round((e.loaded / e.total) * 100);
        document.getElementById('pBar').style.width = p + '%';
        document.getElementById('pNum').innerText = p + '%';
      };
      xhr.onload = () => { if(xhr.status === 200) location.reload(); else alert("Error!"); };
      xhr.open('POST', '/api/upload');
      xhr.send(fd);
    }

    function pP(el) { el.querySelector('video').play(); }
    function pS(el) { const v = el.querySelector('video'); v.pause(); v.currentTime = 0.5; }
    function goHome() { document.getElementById('mainPlayer').pause(); document.getElementById('playerView').style.display='none'; document.getElementById('homeView').style.display='block'; }
    function toggleModal(s) { document.getElementById('upModal').style.display = s ? 'flex' : 'none'; }
    function filterVideos() { const q = document.getElementById('searchInput').value.toLowerCase(); renderGrid(allVideos.filter(v => v.title.toLowerCase().includes(q))); }
    async function deleteVid(id) { if(confirm("Delete?")) { await fetch(`/api/videos/${encodeURIComponent(id)}`, { method: 'DELETE' }); loadVideos(); } }
    
    loadVideos();
  </script>
</body>
</html> -->
